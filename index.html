<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMW Collision Programme Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Darker grey background */
            color: #ffffff; /* White */
        }
        .bg-gray-800 { background-color: #262626; } /* New section/card background */
        .bg-gray-700 { background-color: #404040; } /* Slightly lighter grey for elements */
        .border-gray-700 { border-color: #404040; }
        .text-gray-400 { color: #a3a3a3; } /* Lighter grey for secondary text */
        .text-gray-200 { color: #e5e7eb; }

        /* Custom Toggle Switch Styles */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #D1D5DB; /* gray-300 */
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #059669; /* green-600 */
        }
        .leakage-card {
            background-color: #450a0a; /* red-950 */
            border-color: #7f1d1d; /* red-800 */
            color: #ffffff; /* White text for contrast */
        }
        .uplift-card {
            background-color: #064e3b; /* green-900 */
            border-color: #047857; /* green-700 */
            color: #ffffff; /* White text for contrast */
        }
        /* Custom Slider Styles */
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #404040; /* New slider track color */
            outline: none;
            opacity: 0.9;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }
        .slider:hover {
            opacity: 1;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffffff; /* White thumb */
            cursor: pointer;
        }
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffffff; /* White thumb */
            cursor: pointer;
        }
        /* Hide scrollbar for number inputs in settings */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        .funnel-box-leakage {
            background-color: #450a0a; /* red-950 */
            border-color: #7f1d1d; /* red-800 */
            color: #ffffff;
        }
        .funnel-box-uplift {
            background-color: #064e3b; /* green-900 */
            border-color: #047857; /* green-700 */
            color: #ffffff;
        }
        .funnel-box-info {
            background-color: #262626; /* grey-800 */
            border-color: #404040; /* grey-700 */
            color: #ffffff;
        }
        .funnel-box-start {
            background-color: #262626; /* grey-800 */
            border-color: #404040; /* grey-700 */
            color: #ffffff;
        }
        .funnel-arrow-icon {
            color: #525252; /* Darker grey for icon */
        }
        input[type="number"] {
            background-color: #404040; /* Input background */
            border-color: #525252; /* Input border */
        }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-8 flex items-center space-x-4">
            <img src="https://upload.wikimedia.org/wikipedia/commons/4/44/BMW.svg" alt="BMW Logo" class="h-10 w-10">
            <div>
                <h1 class="text-3xl font-bold text-white">BMW Collision Programme Calculator</h1>
                <p class="mt-1 text-gray-400">Model leakage and uplift for eCall & aCall programmes.</p>
            </div>
        </header>

        <!-- Tabs --><div class="mb-6 border-b border-gray-700">
            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                <button id="tab-calculator" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-white border-white">
                    Calculator
                </button>
                <button id="tab-settings" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-400 hover:text-gray-200 hover:border-gray-500 border-transparent">
                    Settings
                </button>
            </nav>
        </div>

        <!-- Main Content --><main>
            <!-- Calculator View --><div id="view-calculator">
                <!-- Global Inputs --><section class="bg-gray-800 p-6 rounded-xl shadow-sm mb-8">
                    <h2 class="text-xl font-semibold mb-6 text-white">Mission Control</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-8 gap-y-8">
                        <div>
                            <label for="totalConnectedCarParc" class="block text-sm font-medium text-white">Total Connected Car Parc</label>
                            <input type="range" id="totalConnectedCarParc" min="500000" max="4000000" value="2100000" step="100000" class="mt-2 block w-full slider">
                            <span id="totalConnectedCarParcValue" class="font-semibold text-white text-sm mt-2 block text-center">1,200,000</span>
                        </div>
                        <div>
                            <label for="annualCrashRate" class="block text-sm font-medium text-white">Annual Crash Rate (%)</label>
                            <input type="range" id="annualCrashRate" min="1" max="20" value="7" class="mt-2 block w-full slider">
                            <span id="annualCrashRateValue" class="font-semibold text-white text-sm mt-2 block text-center">6%</span>
                        </div>
                        <div>
                            <label for="avgRepairInvoice" class="block text-sm font-medium text-white">Avg. Repair Invoice</label>
                            <input type="range" id="avgRepairInvoice" min="1000" max="10000" value="2500" step="100" class="mt-2 block w-full slider">
                            <span id="avgRepairInvoiceValue" class="font-semibold text-white text-sm mt-2 block text-center">£2,500</span>
                        </div>
                        <div>
                            <label for="avgNewVehicleRevenue" class="block text-sm font-medium text-white">Avg. New Vehicle Sale Revenue</label>
                            <input type="range" id="avgNewVehicleRevenue" min="5000" max="50000" value="30000" step="100" class="mt-2 block w-full slider">
                            <span id="avgNewVehicleRevenueValue" class="font-semibold text-white text-sm mt-2 block text-center">£5,000</span>
                        </div>
                    </div>
                     <div class="mt-8 pt-6 border-t border-gray-700 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <div class="flex items-center justify-between">
                            <span class="font-medium text-white">Mission Control eCall (ACN)</span>
                             <div class="flex items-center space-x-3">
                                <span class="text-sm text-gray-400">Off</span>
                                <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="eCallToggle" id="eCallToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                    <label for="eCallToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-700 cursor-pointer"></label>
                                </div>
                                <span class="text-sm font-semibold text-white">On</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                             <span class="font-medium text-white">Mission Control aCall</span>
                             <div class="flex items-center space-x-3">
                                <span class="text-sm text-gray-400">Off</span>
                                <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="aCallToggle" id="aCallToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                    <label for="aCallToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-700 cursor-pointer"></label>
                                </div>
                                <span class="text-sm font-semibold text-white">On</span>
                            </div>
                        </div>
                    </div>
                </section>
                
                 <!-- Combined Overview Section --><section id="combinedOverview" class="mb-8">
                     <div class="bg-gray-800 p-6 rounded-xl shadow-sm">
                        <h2 class="text-2xl font-bold text-white mb-4">Combined Programme Overview</h2>
                        <div id="combinedResults" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Combined results here --></div>
                    </div>
                </section>


                <!-- eCall Section --><section id="eCallSection" class="mb-8 transition-all duration-300">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-white">eCall Programme</h2>
                            <span id="eCallStatus" class="font-semibold px-3 py-1 text-sm rounded-full"></span>
                        </div>

                        <!-- Results Cards --><div id="eCallResults" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"></div>
                        
                        <!-- Breakdown Funnel --><div id="eCallBreakdown" class="mt-6 pt-6 border-t border-gray-700"></div>
                    </div>
                </section>

                <!-- aCall Section --><section id="aCallSection" class="transition-all duration-300">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-white">aCall Programme</h2>
                            <span id="aCallStatus" class="font-semibold px-3 py-1 text-sm rounded-full"></span>
                        </div>

                        <!-- Results Cards --><div id="aCallResults" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"></div>

                        <!-- Breakdown Funnel --><div id="aCallBreakdown" class="mt-6 pt-6 border-t border-gray-700"></div>
                    </div>
                </section>
            </div>

            <!-- Settings View --><div id="view-settings" class="hidden">
                 <div class="bg-gray-800 p-6 rounded-xl shadow-sm">
                    <p class="text-gray-400 mb-6">Adjust the constants for each calculation model. Changes are applied instantly.</p>
                    <div class="space-y-8">
                        
                        <!-- eCall Settings --><div>
                            <h3 class="text-lg font-semibold border-b border-gray-700 pb-2 mb-4 text-white">eCall Constants</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                                <div id="settings-eCall-off" class="space-y-3 p-4 border border-gray-700 rounded-lg">
                                    <p class="font-medium text-white">Current Programme (Leakage)</p>
                                </div>
                                <div id="settings-eCall-on" class="space-y-3 p-4 border border-gray-700 rounded-lg">
                                    <p class="font-medium text-white">Axitech Programme (Uplift)</p>
                                </div>
                            </div>
                        </div>

                        <!-- aCall Settings --><div>
                            <h3 class="text-lg font-semibold border-b border-gray-700 pb-2 mb-4 text-white">aCall Constants</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                                <div id="settings-aCall-off" class="space-y-3 p-4 border border-gray-700 rounded-lg">
                                    <p class="font-medium text-white">Current Programme (Leakage)</p>
                                </div>
                                <div id="settings-aCall-on" class="space-y-3 p-4 border border-gray-700 rounded-lg">
                                    <p class="font-medium text-white">Axitech Programme (Uplift)</p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- STATE MANAGEMENT ---
            const state = {
                totalConnectedCarParc: 2100000,
                annualCrashRate: 7,
                avgRepairInvoice: 2500,
                avgNewVehicleRevenue: 30000,
                eCallOn: false,
                aCallOn: false,
                activeTab: 'calculator',
                eCall_off_tcsAcceptanceRate: 98,
                eCall_off_acnDetectionRate: 9,
                eCall_off_emergencyAcnSplit: 40,
                eCall_off_nonEmergencyAcnSplit: 60,
                eCall_off_totalLossRate: 6.9,
                eCall_off_inverseCaptivePartsRate: 82,
                eCall_off_totalLossRepurchaseOppRate: 70,
                eCall_off_nonFaultRateForRevenue: 44,
                eCall_off_nonFaultFee: 500,
                eCall_on_tcsAcceptanceRate: 98,
                eCall_on_acnDetectionRate: 9,
                eCall_on_emergencyAcnSplit: 40,
                eCall_on_nonEmergencyAcnSplit: 60,
                eCall_on_totalLossRate: 6.9,
                eCall_on_emergencyConversion: 50,
                eCall_on_nonFaultRate: 44,
                eCall_on_faultRate: 56,
                eCall_on_nonFaultConversion: 80,
                eCall_on_faultConversion: 50,
                eCall_on_totalLossRepurchaseOppRate: 65,
                eCall_on_nonFaultFee: 500,
                aCall_off_detectionRate: 50,
                aCall_off_tcsAcceptanceRate: 20,
                aCall_off_engagementRate: 10,
                aCall_off_totalLossRate: 6.9,
                aCall_off_nonFaultRate: 44,
                aCall_off_faultRate: 56,
                aCall_off_inverseCaptivePartsRate: 82,
                aCall_off_totalLossRateForRepurchase: 6.9,
                aCall_off_nonFaultRateForRevenue: 44,
                aCall_off_nonFaultFee: 500,
                aCall_on_detectionRate: 50,
                aCall_on_tcsAcceptanceRate: 92,
                aCall_on_engagementRate: 70,
                aCall_on_totalLossRate: 6.9,
                aCall_on_nonFaultRate: 44,
                aCall_on_faultRate: 56,
                aCall_on_nonFaultConversion: 80,
                aCall_on_faultConversion: 50,
                aCall_on_totalLossRepurchaseOppRate: 65,
                aCall_on_nonFaultFee: 500,
            };

            // --- DOM ELEMENTS ---
            const dom = {
                tabCalculator: document.getElementById('tab-calculator'),
                tabSettings: document.getElementById('tab-settings'),
                viewCalculator: document.getElementById('view-calculator'),
                viewSettings: document.getElementById('view-settings'),
                totalConnectedCarParc: document.getElementById('totalConnectedCarParc'),
                totalConnectedCarParcValue: document.getElementById('totalConnectedCarParcValue'),
                annualCrashRate: document.getElementById('annualCrashRate'),
                annualCrashRateValue: document.getElementById('annualCrashRateValue'),
                avgRepairInvoice: document.getElementById('avgRepairInvoice'),
                avgRepairInvoiceValue: document.getElementById('avgRepairInvoiceValue'),
                avgNewVehicleRevenue: document.getElementById('avgNewVehicleRevenue'),
                avgNewVehicleRevenueValue: document.getElementById('avgNewVehicleRevenueValue'),
                eCallToggle: document.getElementById('eCallToggle'),
                aCallToggle: document.getElementById('aCallToggle'),
                eCallResults: document.getElementById('eCallResults'),
                eCallBreakdown: document.getElementById('eCallBreakdown'),
                eCallStatus: document.getElementById('eCallStatus'),
                aCallResults: document.getElementById('aCallResults'),
                aCallBreakdown: document.getElementById('aCallBreakdown'),
                aCallStatus: document.getElementById('aCallStatus'),
                combinedResults: document.getElementById('combinedResults'),
                settingsECallOff: document.getElementById('settings-eCall-off'),
                settingsECallOn: document.getElementById('settings-eCall-on'),
                settingsACallOff: document.getElementById('settings-aCall-off'),
                settingsACallOn: document.getElementById('settings-aCall-on'),
            };
            
            // --- SETTINGS MAPPING ---
            const settingsMap = {
                'settings-eCall-off': [
                    { key: 'eCall_off_tcsAcceptanceRate', label: 'T&Cs Acceptance Rate (%)' },
                    { key: 'eCall_off_acnDetectionRate', label: 'ACN Detection Rate (%)' },
                    { key: 'eCall_off_emergencyAcnSplit', label: 'Emergency ACN Split (%)' },
                    { key: 'eCall_off_nonEmergencyAcnSplit', label: 'Non-Emergency ACN Split (%)' },
                    { key: 'eCall_off_totalLossRate', label: 'Total Loss Rate (%)' },
                    { key: 'eCall_off_inverseCaptivePartsRate', label: 'Inverse Captive Parts Rate (%)' },
                    { key: 'eCall_off_totalLossRepurchaseOppRate', label: 'Total Loss Repurchase Rate (%)' },
                    { key: 'eCall_off_nonFaultFee', label: 'Non-Fault Programme Fee (£)', isCurrency: true },
                ],
                'settings-eCall-on': [
                    { key: 'eCall_on_tcsAcceptanceRate', label: 'T&Cs Acceptance Rate (%)' },
                    { key: 'eCall_on_acnDetectionRate', label: 'ACN Detection Rate (%)' },
                    { key: 'eCall_on_emergencyAcnSplit', label: 'Emergency ACN Split (%)' },
                    { key: 'eCall_on_nonEmergencyAcnSplit', label: 'Non-Emergency ACN Split (%)' },
                    { key: 'eCall_on_totalLossRate', label: 'Total Loss Rate (%)' },
                    { key: 'eCall_on_emergencyConversion', label: 'Emergency ACN Event Conversion (%)' },
                    { key: 'eCall_on_nonFaultRate', label: 'Non-Fault Rate (%)' },
                    { key: 'eCall_on_faultRate', label: 'Fault Rate (%)' },
                    { key: 'eCall_on_nonFaultConversion', label: 'Non-Fault Conversion (%)' },
                    { key: 'eCall_on_faultConversion', label: 'Fault Conversion (%)' },
                    { key: 'eCall_on_totalLossRepurchaseOppRate', label: 'Total Loss Repurchase Rate (%)' },
                    { key: 'eCall_on_nonFaultFee', label: 'Non-Fault Programme Fee (£)', isCurrency: true },
                ],
                'settings-aCall-off': [
                    { key: 'aCall_off_detectionRate', label: 'aCall Detection Rate (%)' },
                    { key: 'aCall_off_tcsAcceptanceRate', label: 'T&Cs Acceptance Rate (%)' },
                    { key: 'aCall_off_engagementRate', label: 'Programme Engagement Rate (%)' },
                    { key: 'aCall_off_totalLossRate', label: 'Total Loss Rate (%)' },
                    { key: 'aCall_off_nonFaultRate', label: 'Non-Fault Rate (%)' },
                    { key: 'aCall_off_faultRate', label: 'Fault Rate (%)' },
                    { key: 'aCall_off_inverseCaptivePartsRate', label: 'Inverse Captive Parts Rate (%)' },
                    { key: 'aCall_off_nonFaultFee', label: 'Non-Fault Programme Fee (£)', isCurrency: true },
                ],
                'settings-aCall-on': [
                    { key: 'aCall_on_detectionRate', label: 'aCall Detection Rate (%)' },
                    { key: 'aCall_on_tcsAcceptanceRate', label: 'T&Cs Acceptance Rate (Pre-Consented) (%)' },
                    { key: 'aCall_on_engagementRate', label: 'Programme Engagement Rate (%)' },
                    { key: 'aCall_on_totalLossRate', label: 'Total Loss Rate (%)' },
                    { key: 'aCall_on_nonFaultRate', label: 'Non-Fault Rate (%)' },
                    { key: 'aCall_on_faultRate', label: 'Fault Rate (%)' },
                    { key: 'aCall_on_nonFaultConversion', label: 'Non-Fault Conversion (%)' },
                    { key: 'aCall_on_faultConversion', label: 'Fault Conversion (%)' },
                    { key: 'aCall_on_totalLossRepurchaseOppRate', label: 'Total Loss Repurchase Rate (%)' },
                    { key: 'aCall_on_nonFaultFee', label: 'Non-Fault Programme Fee (£)', isCurrency: true },
                ]
            };


            // --- UTILITY FUNCTIONS ---
            const formatNumber = (num) => Math.round(num).toLocaleString('en-GB');
            const formatCurrency = (num) => `£${Math.round(num).toLocaleString('en-GB')}`;
            const p = (key) => state[key] / 100;

            // --- CALCULATION LOGIC ---

            function calculateECallOff() {
                const totalAccidents = state.totalConnectedCarParc * p('annualCrashRate');
                const detectedAccidents = totalAccidents * p('eCall_off_acnDetectionRate');
                const totalEmergency = detectedAccidents * p('eCall_off_emergencyAcnSplit');
                const totalNonEmergency = detectedAccidents * p('eCall_off_nonEmergencyAcnSplit');
                const emergencyLost = totalEmergency * p('eCall_off_inverseCaptivePartsRate');
                const nonEmergencyLost = totalNonEmergency * p('eCall_off_inverseCaptivePartsRate');
                
                const totalNoTotalLoss = detectedAccidents * p('eCall_off_totalLossRate');
                const totalRepairableEvents = detectedAccidents - totalNoTotalLoss;
                const opportunities = totalRepairableEvents;
                const deployments = totalRepairableEvents * p('eCall_off_inverseCaptivePartsRate');
                const repurchases = totalNoTotalLoss * p('eCall_off_totalLossRepurchaseOppRate');
                const revenue = (deployments * state.avgRepairInvoice) + ((deployments * p('eCall_off_nonFaultRateForRevenue')) * state.eCall_off_nonFaultFee) + (repurchases * state.avgNewVehicleRevenue);
                const totalRepairsLeaked = nonEmergencyLost + emergencyLost;
                const captiveRepairs = totalRepairableEvents * (1 - p('eCall_off_inverseCaptivePartsRate'));
                const captiveRate = 100 - state.eCall_off_inverseCaptivePartsRate;

                return {
                    raw: { opportunities, deployments, repurchases, revenue },
                    cardClass: 'leakage-card',
                    cards: [
                        { label: 'Total Leaked Repair Opportunities', value: formatNumber(opportunities) },
                        { label: 'Total Leaked Repair Deployments', value: formatNumber(deployments) },
                        { label: 'Total Leaked Total Loss Repurchases', value: formatNumber(repurchases) },
                        { label: 'Total Parts Revenue Leakage (£)', value: formatCurrency(revenue) },
                    ],
                    funnelTitle: 'Leakage Funnel',
                    funnel: {
                        type: 'sequential',
                        steps: [
                            { type: 'start', value: totalAccidents, label: 'Total Annual Accidents', desc: 'The total number of connected vehicles multiplied by the annual crash rate.' },
                            { type: 'info', value: detectedAccidents, label: `Total Accidents Detected (${state.eCall_off_acnDetectionRate}%)`, desc: 'The total number of annual crashes that trigger eCall and Airbag deployment.'},
                            { type: 'leakage', value: nonEmergencyLost, label: `Non-Emergency Events (${state.eCall_off_nonEmergencyAcnSplit}%)`, desc: 'Lost due to no Accident Support warm transfer or intervention.' },
                            { type: 'leakage', value: emergencyLost, label: `Emergency Events (${state.eCall_off_emergencyAcnSplit}%)`, desc: 'Lost due to lack of contextual, sensitive follow-up with driver.' },
                            { type: 'uplift', value: captiveRepairs, label: `Captive Parts (${captiveRate.toFixed(0)}%)`, desc: 'The percentage of repair opportunities that use captive parts partially during their repair, or manually opt for a BMW certified repair.' },
                            { type: 'end', value: totalRepairsLeaked, label: 'Total Repairs Leaked', desc: 'The total number of repair opportunities lost from the BMW approved network.' }
                        ]
                    }
                };
            }

            function calculateECallOn() {
                const totalAccidents = state.totalConnectedCarParc * p('annualCrashRate');
                const detectedAccidents = totalAccidents * p('eCall_on_acnDetectionRate');
                const totalEmergency = detectedAccidents * p('eCall_on_emergencyAcnSplit');
                const totalNonEmergency = detectedAccidents * p('eCall_on_nonEmergencyAcnSplit');
                
                const emergencyCaptured = totalEmergency * p('eCall_on_emergencyConversion');
                const nonEmergencyCaptured = totalNonEmergency;
                
                const emergencyNotCaptured = totalEmergency - emergencyCaptured;
                const captiveFromUncaptured = emergencyNotCaptured * (1 - p('eCall_off_inverseCaptivePartsRate'));
                const captiveRate = 100 - state.eCall_off_inverseCaptivePartsRate;

                const totalAddressableRepairable = nonEmergencyCaptured + emergencyCaptured;
                const totalNoTotalLoss = detectedAccidents * p('eCall_on_totalLossRate');
                const opportunities = totalAddressableRepairable - totalNoTotalLoss;

                const nonFaultEvents = opportunities * p('eCall_on_nonFaultRate');
                const faultEvents = opportunities * p('eCall_on_faultRate');
                const nonFaultConverted = nonFaultEvents * p('eCall_on_nonFaultConversion');
                const faultConverted = faultEvents * p('eCall_on_faultConversion');
                const axitechDeployments = nonFaultConverted + faultConverted;
                
                const deployments = axitechDeployments + captiveFromUncaptured;

                const repurchases = totalNoTotalLoss * p('eCall_on_totalLossRepurchaseOppRate');
                const revenue = (deployments * state.avgRepairInvoice) + (nonFaultConverted * state.eCall_on_nonFaultFee) + (repurchases * state.avgNewVehicleRevenue);

                return {
                    raw: { opportunities, deployments, repurchases, revenue },
                    cardClass: 'uplift-card',
                    cards: [
                        { label: 'Total Repair Opportunities Uplift', value: formatNumber(opportunities) },
                        { label: 'Total Repair Deployments Uplift', value: formatNumber(deployments) },
                        { label: 'Total Gained Total Loss Repurchases', value: formatNumber(repurchases) },
                        { label: 'Total Parts Revenue Uplift (£)', value: formatCurrency(revenue) },
                    ],
                    funnelTitle: 'Uplift Funnel',
                    funnel: {
                        type: 'sequential',
                        steps: [
                            { type: 'start', value: totalAccidents, label: 'Total Annual Accidents', desc: 'The total number of connected vehicles multiplied by the annual crash rate.' },
                            { type: 'info', value: detectedAccidents, label: `Total Accidents Detected (${state.eCall_on_acnDetectionRate}%)`, desc: 'The total number of annual crashes that trigger eCall and Airbag deployment.'},
                            { type: 'uplift', value: nonEmergencyCaptured, label: `Non-Emergency Events (${state.eCall_on_nonEmergencyAcnSplit}%)`, desc: 'Gained due to transfer or engagement with Accident Support team.'},
                            { type: 'uplift', value: emergencyCaptured, label: `Emergency Events (${state.eCall_on_emergencyAcnSplit}%)`, desc: 'Gained due to accident support team providing contextual and sensitive follow-up to affected drivers.' },
                            { type: 'uplift', value: captiveFromUncaptured, label: `Captive Parts from Remainder (${captiveRate.toFixed(0)}%)`, desc: 'The percentage of repair opportunities that use captive parts partially during their repair, or manually opt for a BMW certified repair.' },
                            { type: 'end', value: deployments, label: 'Total Repairs Converted', desc: 'The total number of converted repairs into the BMW approved network.' }
                        ]
                    }
                };
            }

            function calculateACallOff() {
                const totalAccidents = state.totalConnectedCarParc * p('annualCrashRate');
                const detected = totalAccidents * p('aCall_off_detectionRate');
                const afterTcs = detected * p('aCall_off_tcsAcceptanceRate');
                const tcsLost = detected - afterTcs;
                const engaged = afterTcs * p('aCall_off_engagementRate');
                const engagementLost = afterTcs - engaged;
                const nonFaultEventsAfterEngagement = engaged * p('aCall_off_nonFaultRate');
                const faultEventsLost = engaged * p('aCall_off_faultRate');
                
                // Calculate actual repairs converted in the "OFF" scenario (minimal)
                const convertedNonFault = nonFaultEventsAfterEngagement * (1 - p('aCall_off_inverseCaptivePartsRate'));
                const totalConvertedRepairs = convertedNonFault; // Assuming fault events are fully leaked in OFF scenario

                // Total leakage is (detected - totalConvertedRepairs)
                const totalRepairsLeaked = detected - totalConvertedRepairs;

                // For cards: Total leaked opportunities, deployments, repurchases, and revenue
                const totalRepairable = detected * (1 - p('aCall_off_totalLossRate'));
                const leakedOpportunities = totalRepairable - totalConvertedRepairs; // Opportunities that could have been converted
                const leakedDeployments = leakedOpportunities * p('aCall_off_inverseCaptivePartsRate'); // Assuming standard leakage rate for "lost" ops
                const leakedRepurchases = detected * p('aCall_off_totalLossRate') * p('aCall_off_totalLossRateForRepurchase'); // Repurchases that could have been gained
                const leakedRevenue = (leakedDeployments * state.avgRepairInvoice) + (leakedDeployments * p('aCall_off_nonFaultRateForRevenue') * state.aCall_off_nonFaultFee) + (leakedRepurchases * state.avgNewVehicleRevenue);

                return {
                    raw: { opportunities: leakedOpportunities, deployments: leakedDeployments, repurchases: leakedRepurchases, revenue: leakedRevenue },
                    cardClass: 'leakage-card',
                    cards: [
                        { label: 'Total Leaked Repair Opportunities', value: formatNumber(leakedOpportunities) },
                        { label: 'Total Leaked Repair Deployments', value: formatNumber(leakedDeployments) },
                        { label: 'Total Leaked Total Loss Repurchases', value: formatNumber(leakedRepurchases) },
                        { label: 'Total Parts Revenue Leakage (£)', value: formatCurrency(leakedRevenue) },
                    ],
                    funnelTitle: 'Leakage Funnel',
                    funnel: {
                        type: 'sequential',
                        steps: [
                            { type: 'start', value: totalAccidents, label: 'Total Annual Accidents', desc: 'The total number of connected vehicles multiplied by the annual crash rate.' },
                            { type: 'info', value: detected, label: `Total Accidents Detected (${state.aCall_off_detectionRate}%)`, desc: 'The total number of annual crashes that trigger aCall detection.'},
                            { type: 'leakage', value: tcsLost, label: `Lost to T&Cs (${100 - state.aCall_off_tcsAcceptanceRate}%)`, desc: 'The total number of BMW drivers that have not opted-in to aCall proactive engagement from BMW Accident Support, or rejected this option.'},
                            { type: 'leakage', value: engagementLost, label: `Lost to Non-Engagement (${100 - state.aCall_off_engagementRate}% of T&C Accepts)`, desc: 'The number of drivers who reject the aCall service offering when it appears in the BMW dashboard after a collision.' },
                            { type: 'leakage', value: faultEventsLost, label: `Fault Events Lost (${state.aCall_off_faultRate}%)`, desc: 'The total number of fault events from the remainder that are leaked through the lack of a fault handling programme.' },
                            { type: 'end', value: totalRepairsLeaked, label: 'Total Repairs Leaked', desc: 'The total number of repair opportunities lost from the BMW approved network.' }
                        ]
                    }
                };
            }

            function calculateACallOn() {
                const totalAccidents = state.totalConnectedCarParc * p('annualCrashRate');
                const detected = totalAccidents * p('aCall_on_detectionRate');
                const tcsAccepted = detected * p('aCall_on_tcsAcceptanceRate');
                const engaged = tcsAccepted * p('aCall_on_engagementRate');
                
                const opportunities = engaged - (engaged * p('aCall_on_totalLossRate'));
                const nonFault = opportunities * p('aCall_on_nonFaultRate');
                const fault = opportunities * p('aCall_on_faultRate');
                
                const nonFaultConverted = nonFault * p('aCall_on_nonFaultConversion');
                const faultConverted = fault * p('aCall_on_faultConversion');
                const deployments = nonFaultConverted + faultConverted;

                const totalNoTotalLoss = engaged * p('aCall_on_totalLossRate');
                const repurchases = totalNoTotalLoss * p('aCall_on_totalLossRepurchaseOppRate');
                const revenue = (deployments * state.avgRepairInvoice) + (nonFaultConverted * state.aCall_on_nonFaultFee) + (repurchases * state.avgNewVehicleRevenue);

                return {
                    raw: { opportunities, deployments, repurchases, revenue },
                    cardClass: 'uplift-card',
                    cards: [
                        { label: 'Total Repair Opportunities Uplift', value: formatNumber(opportunities) },
                        { label: 'Total Repair Deployments Uplift', value: formatNumber(deployments) },
                        { label: 'Total Gained Total Loss Repurchases', value: formatNumber(repurchases) },
                        { label: 'Total Parts Revenue Uplift (£)', value: formatCurrency(revenue) },
                    ],
                    funnelTitle: 'Uplift Funnel',
                    funnel: {
                       type: 'sequential',
                       steps: [
                            { type: 'start', value: totalAccidents, label: 'Total Annual Accidents', desc: 'The total number of connected vehicles multiplied by the annual crash rate.' },
                            { type: 'info', value: detected, label: `Total Accidents Detected (${state.aCall_on_detectionRate}%)`},
                            { type: 'uplift', value: tcsAccepted, label: `T&Cs Accepted (${state.aCall_on_tcsAcceptanceRate}%)`},
                            { type: 'uplift', value: engaged, label: `Engaged into Programme (${state.aCall_on_engagementRate}%)` },
                            { type: 'uplift', value: faultConverted, label: `Fault Events Converted (${state.aCall_on_faultConversion}%)` },
                            { type: 'end', value: deployments, label: 'Total Repairs Converted', desc: 'The total number of converted repairs into the BMW approved network.' }
                        ]
                    }
                };
            }

            // --- RENDER FUNCTIONS ---
            function renderResults(container, breakdownContainer, data, statusEl) {
                container.innerHTML = data.cards.map(card => `
                    <div class="p-5 rounded-lg border ${data.cardClass} flex flex-col justify-between min-h-[120px]">
                        <p class="text-base font-semibold">${card.label}</p>
                        <p class="text-3xl font-bold mt-2 text-right">${card.value}</p>
                    </div>
                `).join('');

                const { steps, type } = data.funnel;
                const title = data.funnelTitle || 'Funnel';
                const downArrowIcon = `<svg class="w-8 h-8 funnel-arrow-icon mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>`;
                
                let funnelHTML = `<h3 class="text-xl font-bold text-white mb-6 text-center">${title}</h3>`;
                
                const createBox = (step, extraClasses = '') => {
                    const bgClass = step.type === 'leakage' ? 'funnel-box-leakage' :
                                    step.type === 'uplift' ? 'funnel-box-uplift' :
                                    'funnel-box-info'; /* Handles info/start/end */
                    
                    const descriptionHTML = step.desc ? `<p class="text-sm font-normal opacity-80 mt-2">${step.desc}</p>` : '';

                    return `
                        <div class="flex flex-col justify-between text-center p-5 rounded-lg shadow-sm w-full flex-grow min-h-[160px] border ${bgClass} ${extraClasses}">
                            <div>
                                <p class="text-lg font-bold">${step.label}</p>
                                ${descriptionHTML}
                            </div>
                            <p class="text-4xl font-bold mt-3">${formatNumber(step.value)}</p>
                        </div>`;
                };


                if (type === 'split') {
                    // This logic branch is not currently used but kept for potential future layouts
                    const [start, info, parallel1, parallel2, end] = steps;
                    funnelHTML += '<div class="grid grid-cols-2 gap-4 justify-items-center">';
                    funnelHTML += `<div class="col-span-2 w-full flex justify-center">${createBox(start, 'w-full max-w-xs')}</div>`;
                    funnelHTML += `<div class="col-span-2">${downArrowIcon}</div>`;
                    funnelHTML += `<div class="col-span-2 w-full flex justify-center">${createBox(info, 'w-full max-w-md')}</div>`;
                    funnelHTML += `<div class="col-span-2">${downArrowIcon}</div>`;
                    funnelHTML += `<div>${createBox(parallel1)}</div>`;
                    funnelHTML += `<div>${createBox(parallel2)}</div>`;
                    funnelHTML += `<div class="col-span-2">${downArrowIcon}</div>`;
                    funnelHTML += `<div class="col-span-2 w-full flex justify-center">${createBox(end, 'w-full max-w-xs')}</div>`;
                    funnelHTML += '</div>';
                } else { // Sequential Funnel
                    funnelHTML += '<div class="grid grid-cols-1 gap-4 justify-items-center">';
                    steps.forEach((step, index) => {
                        funnelHTML += `<div class="w-full flex justify-center">${createBox(step, 'max-w-lg')}</div>`;
                        if (index < steps.length - 1) {
                            funnelHTML += `<div>${downArrowIcon}</div>`;
                        }
                    });
                    funnelHTML += '</div>';
                }
                
                breakdownContainer.innerHTML = funnelHTML;

                // Update Status Badge
                const isUplift = data.cardClass.includes('uplift');
                statusEl.textContent = isUplift ? 'Axitech Uplift' : 'Current Leakage';
                statusEl.className = `font-semibold px-3 py-1 text-sm rounded-full ${isUplift ? 'bg-green-800 text-green-100' : 'bg-red-800 text-red-100'}`;
            }

            function renderOverview(eCallLeakage, eCallUplift, aCallLeakage, aCallUplift) {
                const totalLeakage = {
                    opps: eCallLeakage.raw.opportunities + aCallLeakage.raw.opportunities,
                    deps: eCallLeakage.raw.deployments + aCallLeakage.raw.deployments,
                    rev: eCallLeakage.raw.revenue + aCallLeakage.raw.revenue,
                };
                const totalUplift = {
                    opps: eCallUplift.raw.opportunities + aCallUplift.raw.opportunities,
                    deps: eCallUplift.raw.deployments + aCallUplift.raw.deployments,
                    rev: eCallUplift.raw.revenue + aCallUplift.raw.revenue,
                };

                 const cards = [
                    { label: 'Total Repair Opportunities Leakage', value: formatNumber(totalLeakage.opps), class: 'leakage-card' },
                    { label: 'Total Potential Repair Opportunities Uplift', value: formatNumber(totalUplift.opps), class: 'uplift-card' },
                    { label: 'Total Current Revenue Leakage', value: formatCurrency(totalLeakage.rev), class: 'leakage-card' },
                    { label: 'Total Potential Revenue Uplift', value: formatCurrency(totalUplift.rev), class: 'uplift-card' }
                ];

                dom.combinedResults.innerHTML = cards.map(card => `
                    <div class="p-5 rounded-lg border ${card.class} flex flex-col justify-between min-h-[120px]">
                        <p class="text-base font-semibold">${card.label}</p>
                        <p class="text-3xl font-bold mt-2 text-right">${card.value}</p>
                    </div>
                `).join('');
            }


            function createSettingsInput(setting) {
                const wrapper = document.createElement('div');
                const label = document.createElement('label');
                label.htmlFor = setting.key;
                label.className = "block text-sm font-medium text-white";
                label.textContent = setting.label;
                
                const inputWrapper = document.createElement('div');
                inputWrapper.className = 'relative mt-1 rounded-md shadow-sm';

                if (setting.isCurrency) {
                    const prefix = document.createElement('div');
                    prefix.className = 'pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3';
                    prefix.innerHTML = '<span class="text-gray-400 sm:text-sm">£</span>';
                    inputWrapper.appendChild(prefix);
                }

                const input = document.createElement('input');
                input.type = 'number';
                input.id = setting.key;
                input.value = state[setting.key];
                input.className = 'block w-full rounded-md sm:text-sm bg-gray-700 border-gray-600 text-white focus:border-indigo-500 focus:ring-indigo-500';
                if(setting.isCurrency) input.classList.add('pl-7');

                inputWrapper.appendChild(input);
                wrapper.appendChild(label);
                wrapper.appendChild(inputWrapper);

                input.addEventListener('input', (e) => {
                    updateStateFromUI();
                    calculateAndRender();
                });

                return wrapper;
            }

            function initializeSettings() {
                for (const containerId in settingsMap) {
                    const container = document.getElementById(containerId);
                    if (settingsMap.hasOwnProperty(containerId)) {
                        settingsMap[containerId].forEach(setting => {
                            const inputElement = createSettingsInput(setting);
                            container.appendChild(inputElement);
                        });
                    }
                }
            }

            function calculateAndRender() {
                // Calculate all scenarios
                const eCallOffData = calculateECallOff();
                const eCallOnData = calculateECallOn();
                const aCallOffData = calculateACallOff();
                const aCallOnData = calculateACallOn();

                // Render Overview
                renderOverview(eCallOffData, eCallOnData, aCallOffData, aCallOnData);

                // Render eCall section
                const eCallData = state.eCallOn ? eCallOnData : eCallOffData;
                renderResults(dom.eCallResults, dom.eCallBreakdown, eCallData, dom.eCallStatus);
                
                // Render aCall section
                const aCallData = state.aCallOn ? aCallOnData : aCallOffData;
                renderResults(dom.aCallResults, dom.aCallBreakdown, aCallData, dom.aCallStatus);
            }

            // --- STATE & UI SYNC ---
            function updateStateFromUI() {
                state.totalConnectedCarParc = parseFloat(dom.totalConnectedCarParc.value) || 0;
                state.annualCrashRate = parseFloat(dom.annualCrashRate.value) || 0;
                state.avgRepairInvoice = parseFloat(dom.avgRepairInvoice.value) || 0;
                state.avgNewVehicleRevenue = parseFloat(dom.avgNewVehicleRevenue.value) || 0;
                state.eCallOn = dom.eCallToggle.checked;
                state.aCallOn = dom.aCallToggle.checked;
                
                 for (const containerId in settingsMap) {
                    if (settingsMap.hasOwnProperty(containerId)) {
                        settingsMap[containerId].forEach(setting => {
                            const inputElement = document.getElementById(setting.key);
                            if (inputElement) {
                                 state[setting.key] = parseFloat(inputElement.value) || 0;
                            }
                        });
                    }
                }
            }
            
            // --- EVENT LISTENERS ---
            function setupEventListeners() {
                // Sliders
                const sliders = [
                    { el: dom.totalConnectedCarParc, valEl: dom.totalConnectedCarParcValue, format: (val) => parseInt(val).toLocaleString('en-GB') },
                    { el: dom.annualCrashRate, valEl: dom.annualCrashRateValue, format: (val) => `${val}%` },
                    { el: dom.avgRepairInvoice, valEl: dom.avgRepairInvoiceValue, format: (val) => `£${parseInt(val).toLocaleString('en-GB')}` },
                    { el: dom.avgNewVehicleRevenue, valEl: dom.avgNewVehicleRevenueValue, format: (val) => `£${parseInt(val).toLocaleString('en-GB')}` },
                ];

                sliders.forEach(({ el, valEl, format }) => {
                    el.addEventListener('input', () => {
                        valEl.textContent = format(el.value);
                        updateStateFromUI();
                        calculateAndRender();
                    });
                });

                // Toggles
                [dom.eCallToggle, dom.aCallToggle].forEach(el => {
                    el.addEventListener('change', () => {
                        updateStateFromUI();
                        calculateAndRender();
                    });
                });
                
                // Tabs
                dom.tabCalculator.addEventListener('click', () => {
                    dom.viewCalculator.classList.remove('hidden');
                    dom.viewSettings.classList.add('hidden');
                    dom.tabCalculator.classList.add('text-white', 'border-white');
                    dom.tabCalculator.classList.remove('text-gray-400', 'hover:text-gray-200', 'hover:border-gray-500', 'border-transparent');
                    dom.tabSettings.classList.add('text-gray-400', 'hover:text-gray-200', 'hover:border-gray-500', 'border-transparent');
                    dom.tabSettings.classList.remove('text-white', 'border-white');
                });

                dom.tabSettings.addEventListener('click', () => {
                    dom.viewCalculator.classList.add('hidden');
                    dom.viewSettings.classList.remove('hidden');
                    dom.tabSettings.classList.add('text-white', 'border-white');
                    dom.tabSettings.classList.remove('text-gray-400', 'hover:text-gray-200', 'hover:border-gray-500', 'border-transparent');
                    dom.tabCalculator.classList.add('text-gray-400', 'hover:text-gray-200', 'hover:border-gray-500', 'border-transparent');
                    dom.tabCalculator.classList.remove('text-white', 'border-white');
                });
            }

            // --- INITIALIZATION ---
            function init() {
                initializeSettings();
                setupEventListeners();
                updateStateFromUI();
                calculateAndRender();
            }

            init();
        });
    </script>
</body>
</html>

