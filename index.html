<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMW Collision Programme Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #F7F8FA; 
        }

        /* --- New Component Styles --- */
        .panel {
            background-color: #FFFFFF;
            border-radius: 1rem; /* 16px */
            border: 1px solid #E5E7EB;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
        }
        .main-title { color: #111827; }
        .subtitle { color: #6B7280; }
        .section-title { color: #111827; }
        
        /* Segmented Control for Toggles */
        .segmented-control {
            display: flex;
            background-color: #F3F4F6;
            border-radius: 0.75rem;
            padding: 0.25rem;
            width: 100%;
        }
        .segmented-control button {
            flex: 1;
            padding: 0.5rem 0;
            border-radius: 0.6rem;
            border: none;
            background-color: transparent;
            color: #6B7280;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .segmented-control button.active {
            background-color: #FFFFFF;
            color: #111827;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.07), 0 1px 2px -1px rgb(0 0 0 / 0.07);
        }

        /* Custom Slider Styles */
        .slider { -webkit-appearance: none; width: 100%; height: 6px; border-radius: 3px; background: #E5E7EB; outline: none; opacity: 0.9; transition: opacity .2s; }
        .slider:hover { opacity: 1; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #3B82F6; cursor: pointer; border: 3px solid #FFFFFF; box-shadow: 0 0 0 1px rgba(0,0,0,0.1); }
        .slider::-moz-range-thumb { width: 18px; height: 18px; border-radius: 50%; background: #3B82F6; cursor: pointer; border: 3px solid #FFFFFF; box-shadow: 0 0 0 1px rgba(0,0,0,0.1); }
        
        /* Funnel Box Styles */
        .funnel-box {
            background-color: #FFFFFF;
            border: 1px solid #E5E7EB;
            padding: 1.25rem;
            border-radius: 1rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .funnel-box.leakage { border-top: 4px solid #EF4444; }
        .funnel-box.uplift { border-top: 4px solid #22C55E; }
        .funnel-box.info, .funnel-box.start, .funnel-box.end { border-top: 4px solid #6B7280; }
        
        .reset-button {
             background: none;
             border: none;
             color: #6B7280;
             font-size: 0.875rem;
             font-weight: 600;
             cursor: pointer;
             display: flex;
             align-items: center;
             gap: 0.25rem;
        }
        .reset-button:hover {
            color: #111827;
        }
        
        .settings-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #D1D5DB;
            background-color: #F9FAFB;
            color: #111827;
        }
        .settings-input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #3B82F6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }


    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app" class="max-w-screen-2xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold main-title">BMW Collision Programme Calculator</h1>
                <p class="mt-1 subtitle">Model leakage and uplift for eCall & aCall programmes.</p>
            </div>
            <img src="https://i.postimg.cc/25mHchtn/BMW-x-ERAC-Slidedeck.png" alt="Programme Logo" class="h-16 w-auto">
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Inputs --><div class="lg:col-span-1 space-y-8">
                <div class="panel p-6">
                    <div class="flex items-center justify-between mb-6">
                         <h2 class="text-xl font-bold section-title">Global Inputs</h2>
                         <div class="flex items-center space-x-4">
                             <button id="resetButton" class="reset-button">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5M4 4l1.5 1.5A9 9 0 0120.5 16l-1.5 1.5M20 20l-1.5-1.5A9 9 0 003.5 8l1.5-1.5" />
                                </svg>
                                Reset
                             </button>
                             <div>
                                <button id="tab-calculator" class="px-3 py-1 text-sm font-semibold rounded-md bg-blue-100 text-blue-700">Calculator</button>
                                <button id="tab-settings" class="px-3 py-1 text-sm font-semibold rounded-md text-gray-600">Settings</button>
                             </div>
                         </div>
                    </div>

                    <div id="view-calculator" class="space-y-6">
                        <div>
                            <label for="totalConnectedCarParc" class="block text-sm font-bold text-gray-700">Total Connected Car Parc</label>
                            <input type="range" id="totalConnectedCarParc" min="500000" max="4000000" value="2100000" step="100000" class="mt-2 block w-full slider">
                            <span id="totalConnectedCarParcValue" class="font-semibold text-gray-800 text-sm mt-2 block text-center">2,100,000</span>
                        </div>
                        <div>
                            <label for="annualCrashRate" class="block text-sm font-bold text-gray-700">Annual Crash Rate (%)</label>
                            <input type="range" id="annualCrashRate" min="1" max="20" value="7" class="mt-2 block w-full slider">
                            <span id="annualCrashRateValue" class="font-semibold text-gray-800 text-sm mt-2 block text-center">7%</span>
                        </div>
                        <div>
                            <label for="avgRepairInvoice" class="block text-sm font-bold text-gray-700">Avg. Repair Invoice</label>
                            <input type="range" id="avgRepairInvoice" min="1000" max="10000" value="2500" step="100" class="mt-2 block w-full slider">
                            <span id="avgRepairInvoiceValue" class="font-semibold text-gray-800 text-sm mt-2 block text-center">£2,500</span>
                        </div>
                        <div>
                            <label for="avgNewVehicleRevenue" class="block text-sm font-bold text-gray-700">Avg. New Vehicle Sale Revenue</label>
                            <input type="range" id="avgNewVehicleRevenue" min="5000" max="200000" value="30000" step="100" class="mt-2 block w-full slider">
                            <span id="avgNewVehicleRevenueValue" class="font-semibold text-gray-800 text-sm mt-2 block text-center">£30,000</span>
                        </div>
                        <div>
                            <label for="aCallOnTcsAccept" class="block text-sm font-bold text-gray-700">aCall Pre-Consent (%)</label>
                            <input type="range" id="aCallOnTcsAccept" min="0" max="100" value="92" step="1" class="mt-2 block w-full slider">
                            <span id="aCallOnTcsAcceptValue" class="font-semibold text-gray-800 text-sm mt-2 block text-center">92%</span>
                        </div>

                         <div class="pt-6 border-t border-gray-200 space-y-6">
                             <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Mission Control eCall (ACN)</label>
                                <div class="segmented-control" id="eCallToggleContainer">
                                    <button data-value="false" class="active">Off</button>
                                    <button data-value="true">On</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Mission Control aCall</label>
                                <div class="segmented-control" id="aCallToggleContainer">
                                    <button data-value="false" class="active">Off</button>
                                    <button data-value="true">On</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="view-settings" class="hidden">
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-md font-bold text-gray-800 mb-2">eCall Channel Constants</h3>
                                <div class="space-y-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                    <div id="settings-eCall-off" class="space-y-3"></div>
                                    <div id="settings-eCall-on" class="space-y-3 pt-3 border-t border-gray-200"></div>
                                </div>
                            </div>
                            <div>
                                 <h3 class="text-md font-bold text-gray-800 mb-2">aCall Channel Constants</h3>
                                 <div class="space-y-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                    <div id="settings-aCall-off" class="space-y-3"></div>
                                    <div id="settings-aCall-on" class="space-y-3 pt-3 border-t border-gray-200"></div>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Results --><div class="lg:col-span-2 space-y-8">
                <section id="combinedOverview" class="panel p-6">
                    <h2 class="text-xl font-bold section-title mb-4">Combined Programme Overview</h2>
                    <div id="combinedResults" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                </section>
                
                <div>
                     <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" id="programmeTabs">
                            <button data-tab-target="eCallSection" class="active-tab whitespace-nowrap py-4 px-1 border-b-2 font-semibold text-sm text-blue-600 border-blue-600">
                                eCall Channel
                            </button>
                            <button data-tab-target="aCallSection" class="whitespace-nowrap py-4 px-1 border-b-2 font-semibold text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">
                                aCall Channel
                            </button>
                        </nav>
                    </div>
                    <div class="mt-8">
                        <section id="eCallSection" class="panel tab-panel">
                            <div class="flex justify-between items-center p-6">
                                <h2 class="text-xl font-bold section-title">eCall Channel Details</h2>
                                <span id="eCallStatus" class="font-semibold px-3 py-1 text-xs rounded-full"></span>
                            </div>
                            <div class="px-6 pb-6 space-y-6">
                                <div id="eCallBreakdown"></div>
                                <div id="eCallResults" class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-6 border-t border-gray-200"></div>
                            </div>
                        </section>

                        <section id="aCallSection" class="panel tab-panel hidden">
                             <div class="flex justify-between items-center p-6">
                                <h2 class="text-xl font-bold section-title">aCall Channel Details</h2>
                                <span id="aCallStatus" class="font-semibold px-3 py-1 text-xs rounded-full"></span>
                            </div>
                            <div class="px-6 pb-6 space-y-6">
                                 <div id="aCallBreakdown"></div>
                                <div id="aCallResults" class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-6 border-t border-gray-200"></div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
             const defaultState = {
                totalConnectedCarParc: 2100000,
                annualCrashRate: 7,
                avgRepairInvoice: 2500,
                avgNewVehicleRevenue: 30000,
                aCall_on_tcsAcceptanceRate: 92,
            };

            // --- STATE MANAGEMENT ---
            const state = {
                ...defaultState,
                eCallOn: false,
                aCallOn: false,
                eCall_off_tcsAcceptanceRate: 98,
                eCall_off_acnDetectionRate: 9,
                eCall_off_emergencyAcnSplit: 40,
                eCall_off_nonEmergencyAcnSplit: 60,
                eCall_off_totalLossRate: 6.9,
                eCall_off_inverseCaptivePartsRate: 82,
                eCall_off_totalLossRepurchaseOppRate: 70,
                eCall_off_nonFaultRateForRevenue: 44,
                eCall_off_nonFaultFee: 500,
                eCall_on_tcsAcceptanceRate: 98,
                eCall_on_acnDetectionRate: 9,
                eCall_on_emergencyAcnSplit: 40,
                eCall_on_nonEmergencyAcnSplit: 60,
                eCall_on_totalLossRate: 6.9,
                eCall_on_emergencyConversion: 50,
                eCall_on_nonFaultRate: 44,
                eCall_on_faultRate: 56,
                eCall_on_nonFaultConversion: 80,
                eCall_on_faultConversion: 50,
                eCall_on_totalLossRepurchaseOppRate: 65,
                eCall_on_nonFaultFee: 500,
                aCall_off_detectionRate: 50,
                aCall_off_tcsAcceptanceRate: 20,
                aCall_off_dashboardRejectRate: 80,
                aCall_off_totalLossRate: 6.9,
                aCall_off_nonFaultRate: 44,
                aCall_off_faultRate: 56,
                aCall_off_inverseCaptivePartsRate: 82,
                aCall_off_totalLossRepurchaseOppRate: 70,
                aCall_off_nonFaultRateForRevenue: 44,
                aCall_off_nonFaultFee: 500,
                aCall_on_detectionRate: 50,
                aCall_on_engagementRate: 70,
                aCall_on_totalLossRate: 6.9,
                aCall_on_nonFaultRate: 44,
                aCall_on_faultRate: 56,
                aCall_on_nonFaultConversion: 80,
                aCall_on_faultConversion: 50,
                aCall_on_totalLossRepurchaseOppRate: 65,
                aCall_on_nonFaultFee: 500,
            };

            // --- DOM ELEMENTS ---
            const dom = {
                tabCalculator: document.getElementById('tab-calculator'),
                tabSettings: document.getElementById('tab-settings'),
                viewCalculator: document.getElementById('view-calculator'),
                viewSettings: document.getElementById('view-settings'),
                resetButton: document.getElementById('resetButton'),
                totalConnectedCarParc: document.getElementById('totalConnectedCarParc'),
                totalConnectedCarParcValue: document.getElementById('totalConnectedCarParcValue'),
                annualCrashRate: document.getElementById('annualCrashRate'),
                annualCrashRateValue: document.getElementById('annualCrashRateValue'),
                avgRepairInvoice: document.getElementById('avgRepairInvoice'),
                avgRepairInvoiceValue: document.getElementById('avgRepairInvoiceValue'),
                avgNewVehicleRevenue: document.getElementById('avgNewVehicleRevenue'),
                avgNewVehicleRevenueValue: document.getElementById('avgNewVehicleRevenueValue'),
                aCallOnTcsAccept: document.getElementById('aCallOnTcsAccept'),
                aCallOnTcsAcceptValue: document.getElementById('aCallOnTcsAcceptValue'),
                eCallToggleContainer: document.getElementById('eCallToggleContainer'),
                aCallToggleContainer: document.getElementById('aCallToggleContainer'),
                eCallResults: document.getElementById('eCallResults'),
                eCallBreakdown: document.getElementById('eCallBreakdown'),
                eCallStatus: document.getElementById('eCallStatus'),
                aCallResults: document.getElementById('aCallResults'),
                aCallBreakdown: document.getElementById('aCallBreakdown'),
                aCallStatus: document.getElementById('aCallStatus'),
                combinedResults: document.getElementById('combinedResults'),
                programmeTabs: document.getElementById('programmeTabs'),
                tabPanels: document.querySelectorAll('.tab-panel')
            };
            
            // --- SETTINGS MAPPING ---
            const settingsMap = {
                'settings-eCall-off': [
                    { key: 'eCall_off_tcsAcceptanceRate', label: 'T&Cs Acceptance Rate (%)' },
                    { key: 'eCall_off_acnDetectionRate', label: 'ACN Detection Rate (%)' },
                    { key: 'eCall_off_emergencyAcnSplit', label: 'Emergency ACN Split (%)' },
                    { key: 'eCall_off_nonEmergencyAcnSplit', label: 'Non-Emergency ACN Split (%)' },
                    { key: 'eCall_off_totalLossRate', label: 'Total Loss Rate (%)' },
                    { key: 'eCall_off_inverseCaptivePartsRate', label: 'Inverse Captive Parts Rate (%)' },
                    { key: 'eCall_off_totalLossRepurchaseOppRate', label: 'Total Loss Repurchase Rate (%)' },
                    { key: 'eCall_off_nonFaultFee', label: 'Non-Fault Programme Fee (£)', isCurrency: true },
                ],
                'settings-eCall-on': [
                    { key: 'eCall_on_tcsAcceptanceRate', label: 'T&Cs Acceptance Rate (%)' },
                    { key: 'eCall_on_acnDetectionRate', label: 'ACN Detection Rate (%)' },
                    { key: 'eCall_on_emergencyAcnSplit', label: 'Emergency ACN Split (%)' },
                    { key: 'eCall_on_nonEmergencyAcnSplit', label: 'Non-Emergency ACN Split (%)' },
                    { key: 'eCall_on_totalLossRate', label: 'Total Loss Rate (%)' },
                    { key: 'eCall_on_emergencyConversion', label: 'Emergency ACN Event Conversion (%)' },
                    { key: 'eCall_on_nonFaultRate', label: 'Non-Fault Rate (%)' },
                    { key: 'eCall_on_faultRate', label: 'Fault Rate (%)' },
                    { key: 'eCall_on_nonFaultConversion', label: 'Non-Fault Conversion (%)' },
                    { key: 'eCall_on_faultConversion', label: 'Fault Conversion (%)' },
                    { key: 'eCall_on_totalLossRepurchaseOppRate', label: 'Total Loss Repurchase Rate (%)' },
                    { key: 'eCall_on_nonFaultFee', label: 'Non-Fault Programme Fee (£)', isCurrency: true },
                ],
                'settings-aCall-off': [
                    { key: 'aCall_off_detectionRate', label: 'aCall Detection Rate (%)' },
                    { key: 'aCall_off_tcsAcceptanceRate', label: 'T&Cs Acceptance Rate (%)'},
                    { key: 'aCall_off_dashboardRejectRate', label: 'Dashboard Reject Rate (%)'},
                    { key: 'aCall_off_totalLossRate', label: 'Total Loss Rate (%)' },
                    { key: 'aCall_off_nonFaultRate', label: 'Non-Fault Rate (%)' },
                    { key: 'aCall_off_faultRate', label: 'Fault Rate (%)' },
                    { key: 'aCall_off_inverseCaptivePartsRate', label: 'Inverse Captive Parts Rate (%)' },
                    { key: 'aCall_off_totalLossRepurchaseOppRate', label: 'Total Loss Repurchase Rate (%)' },
                    { key: 'aCall_off_nonFaultFee', label: 'Non-Fault Programme Fee (£)', isCurrency: true },
                ],
                'settings-aCall-on': [
                    { key: 'aCall_on_detectionRate', label: 'aCall Detection Rate (%)' },
                    { key: 'aCall_on_engagementRate', label: 'Programme Engagement Rate (%)' },
                    { key: 'aCall_on_totalLossRate', label: 'Total Loss Rate (%)' },
                    { key: 'aCall_on_nonFaultRate', label: 'Non-Fault Rate (%)' },
                    { key: 'aCall_on_faultRate', label: 'Fault Rate (%)' },
                    { key: 'aCall_on_nonFaultConversion', label: 'Non-Fault Conversion (%)' },
                    { key: 'aCall_on_faultConversion', label: 'Fault Conversion (%)' },
                    { key: 'aCall_on_totalLossRepurchaseOppRate', label: 'Total Loss Repurchase Rate (%)' },
                    { key: 'aCall_on_nonFaultFee', label: 'Non-Fault Programme Fee (£)', isCurrency: true },
                ]
            };


            // --- UTILITY FUNCTIONS ---
            const formatNumber = (num) => Math.round(num).toLocaleString('en-GB');
            const formatCurrency = (num) => `£${Math.round(num).toLocaleString('en-GB')}`;
            const p = (key) => state[key] / 100;

            // --- CALCULATION LOGIC ---

            function calculateECallOff() {
                const totalAccidents = state.totalConnectedCarParc * p('annualCrashRate');
                const detectedAccidents = totalAccidents * p('eCall_off_acnDetectionRate');
                const tcsLost = detectedAccidents * (1 - p('eCall_off_tcsAcceptanceRate'));
                const afterTcs = detectedAccidents - tcsLost;

                const totalNoTotalLoss = afterTcs * p('eCall_off_totalLossRate');
                const totalRepairableEvents = afterTcs - totalNoTotalLoss;
                
                const deployments = totalRepairableEvents * p('eCall_off_inverseCaptivePartsRate');
                const repurchases = totalNoTotalLoss * p('eCall_off_totalLossRepurchaseOppRate');
                const revenue = (deployments * state.avgRepairInvoice) + ((deployments * p('eCall_off_nonFaultRateForRevenue')) * state.eCall_off_nonFaultFee) + (repurchases * state.avgNewVehicleRevenue);
                
                const captiveRepairs = totalRepairableEvents * (1 - p('eCall_off_inverseCaptivePartsRate'));
                const captiveRate = 100 - state.eCall_off_inverseCaptivePartsRate;
                const totalRepairsLeaked = totalRepairableEvents - captiveRepairs;
                const nonEmergencyRatio = state.eCall_off_nonEmergencyAcnSplit / (state.eCall_off_nonEmergencyAcnSplit + state.eCall_off_emergencyAcnSplit);
                const nonEmergencyLost = totalRepairsLeaked * nonEmergencyRatio;
                const emergencyLost = totalRepairsLeaked * (1 - nonEmergencyRatio);

                return {
                    raw: { opportunities: totalRepairableEvents, deployments, repurchases, revenue },
                    cardClass: 'leakage',
                    cards: [
                        { label: 'Total Leaked Repair Opportunities', value: formatNumber(totalRepairableEvents) },
                        { label: 'Total Leaked Repair Deployments', value: formatNumber(deployments) },
                        { label: 'Total Leaked Total Loss Repurchases', value: formatNumber(repurchases) },
                        { label: 'Total Parts Revenue Leakage (£)', value: formatCurrency(revenue) },
                    ],
                    funnelTitle: 'Leakage Funnel',
                    funnel: {
                        type: 'sequential',
                        steps: [
                            { type: 'start', value: totalAccidents, label: 'Total Annual Accidents', desc: 'The total number of connected vehicles multiplied by the annual crash rate.' },
                            { type: 'info', value: detectedAccidents, label: `Total Accidents Detected (${state.eCall_off_acnDetectionRate}%)`, desc: 'The total number of annual crashes that trigger eCall and Airbag deployment.'},
                            { type: 'leakage', value: tcsLost, label: `Lost to T&Cs (${100 - state.eCall_off_tcsAcceptanceRate}%)`, desc: 'Lost due to drivers not accepting T&Cs.' },
                            { 
                                type: 'parallel',
                                steps: [
                                    { type: 'leakage', value: nonEmergencyLost, label: `Non-Emergency Events (${state.eCall_off_nonEmergencyAcnSplit}%)`, desc: 'Lost due to no Accident Support warm transfer or intervention.' },
                                    { type: 'leakage', value: emergencyLost, label: `Emergency Events (${state.eCall_off_emergencyAcnSplit}%)`, desc: 'Lost due to lack of contextual, sensitive follow-up with driver.' }
                                ]
                            },
                            { type: 'end', value: totalRepairsLeaked, label: 'Total Repairs Leaked (ex. Total Loss)', desc: 'The total number of repair opportunities lost from the BMW approved network.' }
                        ]
                    }
                };
            }

            function calculateECallOn() {
                const totalAccidents = state.totalConnectedCarParc * p('annualCrashRate');
                const detectedAccidents = totalAccidents * p('eCall_on_acnDetectionRate');
                const tcsLost = detectedAccidents * (1 - p('eCall_on_tcsAcceptanceRate'));
                const afterTcs = detectedAccidents - tcsLost;
                
                const totalNoTotalLoss = afterTcs * p('eCall_on_totalLossRate');
                
                const totalEmergency = afterTcs * p('eCall_on_emergencyAcnSplit');
                const totalNonEmergency = afterTcs * p('eCall_on_nonEmergencyAcnSplit');
                
                const emergencyCaptured = totalEmergency * p('eCall_on_emergencyConversion');
                const nonEmergencyCaptured = totalNonEmergency;
                
                const emergencyNotCaptured = totalEmergency - emergencyCaptured;
                const captiveFromUncaptured = emergencyNotCaptured * (1 - p('eCall_off_inverseCaptivePartsRate'));
                const captiveRate = 100 - state.eCall_off_inverseCaptivePartsRate;

                const totalAddressableRepairable = nonEmergencyCaptured + emergencyCaptured;
                const opportunities = totalAddressableRepairable - totalNoTotalLoss;

                const nonFaultEvents = opportunities * p('eCall_on_nonFaultRate');
                const faultEvents = opportunities * p('eCall_on_faultRate');
                const nonFaultConverted = nonFaultEvents * p('eCall_on_nonFaultConversion');
                const faultConverted = faultEvents * p('eCall_on_faultConversion');
                const axitechDeployments = nonFaultConverted + faultConverted;
                
                const deployments = axitechDeployments + captiveFromUncaptured;
                const repurchases = totalNoTotalLoss * p('eCall_on_totalLossRepurchaseOppRate');
                const revenue = (deployments * state.avgRepairInvoice) + (nonFaultConverted * state.eCall_on_nonFaultFee) + (repurchases * state.avgNewVehicleRevenue);

                return {
                    raw: { opportunities, deployments, repurchases, revenue },
                    cardClass: 'uplift',
                    cards: [
                        { label: 'Total Repair Opportunities Uplift', value: formatNumber(opportunities) },
                        { label: 'Total Repair Deployments Uplift', value: formatNumber(deployments) },
                        { label: 'Total Gained Total Loss Repurchases', value: formatNumber(repurchases) },
                        { label: 'Total Parts Revenue Uplift (£)', value: formatCurrency(revenue) },
                    ],
                    funnelTitle: 'Uplift Funnel',
                    funnel: {
                        type: 'sequential',
                        steps: [
                            { type: 'start', value: totalAccidents, label: 'Total Annual Accidents', desc: 'The total number of connected vehicles multiplied by the annual crash rate.' },
                            { type: 'info', value: detectedAccidents, label: `Total Accidents Detected (${state.eCall_on_acnDetectionRate}%)`, desc: 'The total number of annual crashes that trigger eCall and Airbag deployment.'},
                            { type: 'leakage', value: tcsLost, label: `Lost to T&Cs (${100 - state.eCall_on_tcsAcceptanceRate}%)`, desc: 'Lost due to drivers not accepting T&Cs.' },
                            { 
                                type: 'parallel',
                                steps: [
                                    { type: 'uplift', value: nonEmergencyCaptured, label: `Non-Emergency Events (${state.eCall_on_nonEmergencyAcnSplit}%)`, desc: 'Gained due to transfer or engagement with Accident Support team.'},
                                    { type: 'uplift', value: emergencyCaptured, label: `Emergency Events (${state.eCall_on_emergencyAcnSplit}%)`, desc: 'Gained due to accident support team providing contextual and sensitive follow-up to affected drivers.' }
                                ]
                            },
                            { type: 'end', value: deployments, label: 'Total Repairs Converted (ex. Total Loss)', desc: 'The total number of converted repairs into the BMW approved network.' }
                        ]
                    }
                };
            }

            function calculateACallOff() {
                const totalAccidents = state.totalConnectedCarParc * p('annualCrashRate');
                const detected = totalAccidents * p('aCall_off_detectionRate');

                const tcsLost = detected * (1 - p('aCall_off_tcsAcceptanceRate'));
                const afterTcs = detected - tcsLost;
                
                const dashboardRejectLost = afterTcs * p('aCall_off_dashboardRejectRate');
                const afterDashboard = afterTcs - dashboardRejectLost;

                const repairableAfterDashboard = afterDashboard * (1 - p('aCall_off_totalLossRate'));
                const captiveRepairs = repairableAfterDashboard * (1 - p('aCall_off_inverseCaptivePartsRate'));
                
                const totalRepairablePool = detected * (1- p('aCall_off_totalLossRate'));
                const totalRepairsLeaked = totalRepairablePool - captiveRepairs;

                const opportunities = totalRepairablePool;
                const deployments = totalRepairsLeaked;
                const totalNoTotalLoss = detected * p('aCall_off_totalLossRate');
                const repurchases = totalNoTotalLoss * p('aCall_off_totalLossRepurchaseOppRate');
                const revenue = (deployments * state.avgRepairInvoice) + ((deployments * p('aCall_off_nonFaultRateForRevenue')) * state.aCall_off_nonFaultFee) + (repurchases * state.avgNewVehicleRevenue);
                
                const captiveRate = 100 - state.aCall_off_inverseCaptivePartsRate;
                
                return {
                    raw: { opportunities, deployments, repurchases, revenue },
                    cardClass: 'leakage',
                    cards: [
                        { label: 'Total Leaked Repair Opportunities', value: formatNumber(opportunities) },
                        { label: 'Total Leaked Repair Deployments', value: formatNumber(deployments) },
                        { label: 'Total Leaked Total Loss Repurchases', value: formatNumber(repurchases) },
                        { label: 'Total Parts Revenue Leakage (£)', value: formatCurrency(revenue) },
                    ],
                    funnelTitle: 'Leakage Funnel',
                    funnel: {
                        type: 'sequential',
                        steps: [
                            { type: 'start', value: totalAccidents, label: 'Total Annual Accidents', desc: 'The total number of connected vehicles multiplied by the annual crash rate.' },
                            { type: 'info', value: detected, label: `Total Accidents Detected (${state.aCall_off_detectionRate}%)`, desc: 'The total number of annual crashes that trigger aCall detection.'},
                            { type: 'leakage', value: tcsLost, label: `Lost to T&Cs (${(100 - state.aCall_off_tcsAcceptanceRate).toFixed(0)}%)`, desc: 'The total number of BMW drivers that have not opted-in to aCall proactive engagement from BMW Accident Support, or rejected this option.'},
                            { type: 'leakage', value: dashboardRejectLost, label: `Reject in Dashboard (${state.aCall_off_dashboardRejectRate}%)`, desc: 'The number of drivers who reject the aCall service offering when it appears in the BMW dashboard after a collision.' },
                            { type: 'end', value: totalRepairsLeaked, label: 'Total Repairs Leaked (ex. Total Loss)', desc: 'The total number of repair opportunities lost from the BMW approved network.' }
                        ]
                    }
                };
            }

            function calculateACallOn() {
                const totalAccidents = state.totalConnectedCarParc * p('annualCrashRate');
                const detected = totalAccidents * p('aCall_on_detectionRate');

                const baseTcsAcceptRate = 0.98; // 98% is the base acceptance
                const tcsLost = detected * (1 - baseTcsAcceptRate);
                const afterBaseTcs = detected - tcsLost;
                
                const tcsAccepted = afterBaseTcs * p('aCall_on_tcsAcceptanceRate');
                const engaged = tcsAccepted * p('aCall_on_engagementRate');
                
                const opportunities = engaged - (engaged * p('aCall_on_totalLossRate'));
                
                const nonFaultConverted = opportunities * p('aCall_on_nonFaultRate') * p('aCall_on_nonFaultConversion');
                const faultConverted = opportunities * p('aCall_on_faultRate') * p('aCall_on_faultConversion');
                const deployments = nonFaultConverted + faultConverted;

                const totalNoTotalLoss = detected * p('aCall_on_totalLossRate');
                const repurchases = totalNoTotalLoss * p('aCall_on_totalLossRepurchaseOppRate');
                const revenue = (deployments * state.avgRepairInvoice) + (nonFaultConverted * state.aCall_on_nonFaultFee) + (repurchases * state.avgNewVehicleRevenue);

                return {
                    raw: { opportunities, deployments, repurchases, revenue },
                    cardClass: 'uplift',
                    cards: [
                        { label: 'Total Repair Opportunities Uplift', value: formatNumber(opportunities) },
                        { label: 'Total Repair Deployments Uplift', value: formatNumber(deployments) },
                        { label: 'Total Gained Total Loss Repurchases', value: formatNumber(repurchases) },
                        { label: 'Total Parts Revenue Uplift (£)', value: formatCurrency(revenue) },
                    ],
                    funnelTitle: 'Uplift Funnel',
                    funnel: {
                       type: 'sequential',
                       steps: [
                            { type: 'start', value: totalAccidents, label: 'Total Annual Accidents', desc: 'The total number of connected vehicles multiplied by the annual crash rate.' },
                            { type: 'info', value: detected, label: `Total Accidents Detected (${state.aCall_on_detectionRate}%)`, desc: 'The total number of annual crashes that trigger aCall detection.'},
                            { type: 'leakage', value: tcsLost, label: `Lost to T&Cs (${(100- (baseTcsAcceptRate*100)).toFixed(0)}%)`, desc: 'Lost due to drivers not accepting T&Cs.' },
                            { type: 'uplift', value: tcsAccepted, label: `Pre-consented T&Cs (${state.aCall_on_tcsAcceptanceRate}%)`, desc: 'The uplifted number of drivers who accept aCall T&Cs through pre-consent channels.'},
                            { type: 'uplift', value: engaged, label: `Engaged into Programme (${state.aCall_on_engagementRate}%)`, desc: 'the uplifted number of drivers who engage into aCall service offering through BMW Accident Support team proactive contact with driver.' },
                            { type: 'end', value: deployments, label: 'Total Repairs Converted (ex. Total Loss)', desc: 'The total number of converted repairs into the BMW approved network.' }
                        ]
                    }
                };
            }

            // --- RENDER FUNCTIONS ---
            function renderResults(container, breakdownContainer, data, statusEl) {
                const cardClasses = {
                    leakage: 'bg-red-50 border-red-200',
                    uplift: 'bg-green-50 border-green-200',
                };
                const textClasses = {
                    leakage: 'text-red-700',
                    uplift: 'text-green-700'
                }

                container.innerHTML = data.cards.map(card => `
                    <div class="p-4 rounded-xl ${cardClasses[data.cardClass]}">
                        <p class="text-sm font-semibold text-gray-600">${card.label}</p>
                        <p class="text-3xl font-bold mt-1 ${textClasses[data.cardClass]}">${card.value}</p>
                    </div>
                `).join('');

                const { steps } = data.funnel;
                const title = data.funnelTitle || 'Funnel';
                const downArrowIcon = `<svg class="w-6 h-6 text-gray-300 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>`;
                
                let funnelHTML = `<h3 class="text-lg font-bold text-gray-800 mb-4 text-center">${title}</h3>`;
                
                const createBox = (step) => {
                     const descriptionHTML = step.desc ? `<p class="text-sm text-gray-500 mt-1">${step.desc}</p>` : '';
                    return `
                        <div class="funnel-box ${step.type}">
                            <div>
                                <p class="text-md font-bold text-gray-800">${step.label}</p>
                                ${descriptionHTML}
                            </div>
                            <p class="text-4xl font-extrabold text-gray-900 mt-2">${formatNumber(step.value)}</p>
                        </div>`;
                };

                funnelHTML += '<div class="grid grid-cols-1 gap-4 justify-items-center">';
                steps.forEach((step, index) => {
                    if (step.type === 'parallel') {
                        funnelHTML += '<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full">';
                        step.steps.forEach(parallelStep => {
                            funnelHTML += createBox(parallelStep);
                        });
                        funnelHTML += '</div>';
                    } else {
                        funnelHTML += `<div class="w-full flex justify-center max-w-lg">${createBox(step)}</div>`;
                    }

                    if (index < steps.length - 1) {
                        funnelHTML += `<div>${downArrowIcon}</div>`;
                    }
                });
                funnelHTML += '</div>';
                
                breakdownContainer.innerHTML = funnelHTML;

                // Update Status Badge
                const isUplift = data.cardClass.includes('uplift');
                statusEl.textContent = isUplift ? 'Axitech Uplift' : 'Current Leakage';
                statusEl.className = `font-semibold px-3 py-1 text-xs rounded-full ${isUplift ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            }

            function renderOverview(eCallLeakage, eCallUplift, aCallLeakage, aCallUplift) {
                const totalLeakage = {
                    opps: eCallLeakage.raw.opportunities + aCallLeakage.raw.opportunities,
                    rev: eCallLeakage.raw.revenue + aCallLeakage.raw.revenue,
                };
                const totalUplift = {
                    opps: eCallUplift.raw.opportunities + aCallUplift.raw.opportunities,
                    rev: eCallUplift.raw.revenue + aCallUplift.raw.revenue,
                };

                 const cards = [
                    { label: 'Total Repair Opportunities Leakage', value: formatNumber(totalLeakage.opps), class: 'leakage', text: 'text-red-700', bg: 'bg-red-50', border: 'border-red-200' },
                    { label: 'Total Potential Repair Opportunities Uplift', value: formatNumber(totalUplift.opps), class: 'uplift', text: 'text-green-700', bg: 'bg-green-50', border: 'border-green-200' },
                    { label: 'Total Parts Invoice Value Leakage', value: formatCurrency(totalLeakage.rev), class: 'leakage', text: 'text-red-700', bg: 'bg-red-50', border: 'border-red-200' },
                    { label: 'Total Potential Revenue Uplift', value: formatCurrency(totalUplift.rev), class: 'uplift', text: 'text-green-700', bg: 'bg-green-50', border: 'border-green-200' }
                ];

                dom.combinedResults.innerHTML = cards.map(card => `
                    <div class="p-4 rounded-xl ${card.bg} ${card.border}">
                        <p class="text-sm font-semibold text-gray-600">${card.label}</p>
                        <p class="text-3xl font-bold mt-1 ${card.text}">${card.value}</p>
                    </div>
                `).join('');
            }

            function calculateAndRender() {
                const eCallOffData = calculateECallOff();
                const eCallOnData = calculateECallOn();
                const aCallOffData = calculateACallOff();
                const aCallOnData = calculateACallOn();

                renderOverview(eCallOffData, eCallOnData, aCallOffData, aCallOnData);

                const eCallData = state.eCallOn ? eCallOnData : eCallOffData;
                renderResults(dom.eCallResults, dom.eCallBreakdown, eCallData, dom.eCallStatus);
                
                const aCallData = state.aCallOn ? aCallOnData : aCallOffData;
                renderResults(dom.aCallResults, dom.aCallBreakdown, aCallData, dom.aCallStatus);
            }

            function updateStateFromUI() {
                state.totalConnectedCarParc = parseFloat(dom.totalConnectedCarParc.value) || 0;
                state.annualCrashRate = parseFloat(dom.annualCrashRate.value) || 0;
                state.avgRepairInvoice = parseFloat(dom.avgRepairInvoice.value) || 0;
                state.avgNewVehicleRevenue = parseFloat(dom.avgNewVehicleRevenue.value) || 0;
                state.aCall_on_tcsAcceptanceRate = parseFloat(dom.aCallOnTcsAccept.value) || 0;
                
                for (const containerId in settingsMap) {
                    if (settingsMap.hasOwnProperty(containerId)) {
                        settingsMap[containerId].forEach(setting => {
                            const inputElement = document.getElementById(setting.key);
                            if (inputElement) {
                                state[setting.key] = parseFloat(inputElement.value) || 0;
                            }
                        });
                    }
                }
            }
            
            function setupEventListeners() {
                const sliders = [
                    { el: dom.totalConnectedCarParc, valEl: dom.totalConnectedCarParcValue, format: (val) => parseInt(val).toLocaleString('en-GB') },
                    { el: dom.annualCrashRate, valEl: dom.annualCrashRateValue, format: (val) => `${val}%` },
                    { el: dom.avgRepairInvoice, valEl: dom.avgRepairInvoiceValue, format: (val) => `£${parseInt(val).toLocaleString('en-GB')}` },
                    { el: dom.avgNewVehicleRevenue, valEl: dom.avgNewVehicleRevenueValue, format: (val) => `£${parseInt(val).toLocaleString('en-GB')}` },
                    { el: dom.aCallOnTcsAccept, valEl: dom.aCallOnTcsAcceptValue, format: (val) => `${val}%`},
                ];

                sliders.forEach(({ el, valEl, format }) => {
                    if (el) {
                        valEl.textContent = format(el.value); // Set initial value
                        el.addEventListener('input', () => {
                            valEl.textContent = format(el.value);
                            updateStateFromUI();
                            calculateAndRender();
                        });
                    }
                });
                
                if (dom.resetButton) {
                    dom.resetButton.addEventListener('click', () => {
                        Object.keys(defaultState).forEach(key => {
                            state[key] = defaultState[key];
                        });
                        
                        sliders.forEach(({ el, valEl, format }) => {
                            const sliderKey = Object.keys(defaultState).find(k => k.toLowerCase().includes(el.id.toLowerCase()));
                             if(defaultState[sliderKey] !== undefined) {
                                el.value = defaultState[sliderKey];
                                valEl.textContent = format(el.value);
                            }
                        });
                        
                        Object.keys(settingsMap).forEach(containerId => {
                            settingsMap[containerId].forEach(setting => {
                                const input = document.getElementById(setting.key);
                                if(input && state[setting.key] !== undefined) {
                                    input.value = state[setting.key];
                                }
                            });
                        });


                        calculateAndRender();
                    });
                }


                function handleToggle(container, stateKey) {
                    if (container) {
                        container.addEventListener('click', (e) => {
                            if (e.target.tagName === 'BUTTON') {
                                const value = e.target.dataset.value === 'true';
                                state[stateKey] = value;
                                container.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                                e.target.classList.add('active');
                                calculateAndRender();
                            }
                        });
                    }
                }
                handleToggle(dom.eCallToggleContainer, 'eCallOn');
                handleToggle(dom.aCallToggleContainer, 'aCallOn');
                
                 dom.tabCalculator.addEventListener('click', () => {
                    dom.viewCalculator.classList.remove('hidden');
                    dom.viewSettings.classList.add('hidden');
                    dom.tabCalculator.classList.add('bg-blue-100', 'text-blue-700');
                    dom.tabCalculator.classList.remove('text-gray-600');
                    dom.tabSettings.classList.add('text-gray-600');
                    dom.tabSettings.classList.remove('bg-blue-100', 'text-blue-700');
                });

                dom.tabSettings.addEventListener('click', () => {
                    dom.viewCalculator.classList.add('hidden');
                    dom.viewSettings.classList.remove('hidden');
                    dom.tabSettings.classList.add('bg-blue-100', 'text-blue-700');
                    dom.tabSettings.classList.remove('text-gray-600');
                    dom.tabCalculator.classList.add('text-gray-600');
                    dom.tabCalculator.classList.remove('bg-blue-100', 'text-blue-700');
                });

                if(dom.programmeTabs) {
                    dom.programmeTabs.addEventListener('click', (e) => {
                         const clickedTab = e.target.closest('button');
                         if (!clickedTab) return;

                        dom.programmeTabs.querySelectorAll('button').forEach(btn => {
                            btn.classList.remove('text-blue-600', 'border-blue-600');
                            btn.classList.add('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                        });
                        clickedTab.classList.add('text-blue-600', 'border-blue-600');
                        clickedTab.classList.remove('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');

                        const targetId = clickedTab.dataset.tabTarget;
                        dom.tabPanels.forEach(panel => {
                            if (panel.id === targetId) {
                                panel.classList.remove('hidden');
                            } else {
                                panel.classList.add('hidden');
                            }
                        });
                    });
                }
            }

            function createSettingsInput(setting) {
                const wrapper = document.createElement('div');
                wrapper.className = "flex items-center justify-between";
                const label = document.createElement('label');
                label.htmlFor = setting.key;
                label.className = "block text-sm font-medium text-gray-700";
                label.textContent = setting.label;
                
                const input = document.createElement('input');
                input.type = 'number';
                input.id = setting.key;
                input.value = state[setting.key];
                input.className = 'settings-input w-28 text-right';
                
                wrapper.appendChild(label);
                wrapper.appendChild(input);

                input.addEventListener('input', (e) => {
                    updateStateFromUI();
                    calculateAndRender();
                });

                return wrapper;
            }

            function initializeSettings() {
                const containers = {
                    'settings-eCall-off': document.querySelector('#view-settings #settings-eCall-off'),
                    'settings-eCall-on': document.querySelector('#view-settings #settings-eCall-on'),
                    'settings-aCall-off': document.querySelector('#view-settings #settings-aCall-off'),
                    'settings-aCall-on': document.querySelector('#view-settings #settings-aCall-on'),
                };

                Object.values(containers).forEach(c => { if(c) c.innerHTML = ''; });
                
                containers['settings-eCall-off'].innerHTML = '<p class="font-bold text-gray-800">Current Programme (Leakage)</p>';
                containers['settings-eCall-on'].innerHTML = '<p class="font-bold text-gray-800">Axitech Programme (Uplift)</p>';
                containers['settings-aCall-off'].innerHTML = '<p class="font-bold text-gray-800">Current Programme (Leakage)</p>';
                containers['settings-aCall-on'].innerHTML = '<p class="font-bold text-gray-800">Axitech Programme (Uplift)</p>';

                for (const containerId in settingsMap) {
                    const container = containers[containerId];
                    if (settingsMap.hasOwnProperty(containerId) && container) {
                        settingsMap[containerId].forEach(setting => {
                            const inputElement = createSettingsInput(setting);
                            container.appendChild(inputElement);
                        });
                    }
                }
            }


            function init() {
                initializeSettings();
                setupEventListeners();
                updateStateFromUI();
                calculateAndRender();
            }

            init();
        });
    </script>
</body>
</html>


